@{
    ViewData["Title"] = "User Analytics";
}

<section class="analytics-section">
    <div class="container-fluid px-4">
        <!-- Page Header -->
        <div class="admin-page-header animate-fade-in">
            <a asp-action="Index" class="back-link">
                <i class="bi bi-arrow-left"></i> Back to Analytics
            </a>
            <h1 class="admin-page-title">
                <i class="bi bi-people-fill"></i> User Analytics
            </h1>
            <p class="admin-page-subtitle">User growth, registrations, and performance insights</p>
        </div>

        <!-- Stats Cards -->
        <div class="row g-4 mb-4">
            <div class="col-xl-3 col-md-6">
                <div class="stat-card animate-fade-in">
                    <div class="stat-icon users">
                        <i class="bi bi-people"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">@ViewBag.TotalUsers</h3>
                        <p class="stat-label">Total Users</p>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="stat-card animate-fade-in">
                    <div class="stat-icon active">
                        <i class="bi bi-calendar-week"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">@ViewBag.NewUsersThisWeek</h3>
                        <p class="stat-label">New Users This Week</p>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="stat-card animate-fade-in">
                    <div class="stat-icon notes">
                        <i class="bi bi-calendar-month"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">@ViewBag.NewUsersThisMonth</h3>
                        <p class="stat-label">New Users This Month</p>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="stat-card animate-fade-in">
                    <div class="stat-icon storage">
                        <i class="bi bi-person-check"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-number">@ViewBag.ActiveUsers</h3>
                        <p class="stat-label">Active Users</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Active vs Inactive Ratio -->
            <div class="col-lg-6">
                <div class="dashboard-card animate-fade-in">
                    <div class="card-header">
                        <h5><i class="bi bi-pie-chart"></i> Active vs Inactive Users</h5>
                    </div>
                    <div class="card-body">
                        <div class="ratio-display">
                            <div class="ratio-item active">
                                <div class="ratio-bar" style="width: @(ViewBag.TotalUsers > 0 ? (ViewBag.ActiveUsers * 100 / ViewBag.TotalUsers) : 0)%"></div>
                                <div class="ratio-info">
                                    <span class="ratio-label">Active</span>
                                    <span class="ratio-value">@ViewBag.ActiveUsers</span>
                                </div>
                            </div>
                            <div class="ratio-item inactive">
                                <div class="ratio-bar" style="width: @(ViewBag.TotalUsers > 0 ? (ViewBag.InactiveUsers * 100 / ViewBag.TotalUsers) : 0)%"></div>
                                <div class="ratio-info">
                                    <span class="ratio-label">Inactive</span>
                                    <span class="ratio-value">@ViewBag.InactiveUsers</span>
                                </div>
                            </div>
                        </div>
                        <div class="ratio-percentage text-center mt-3">
                            <span class="badge bg-success fs-6">
                                @(ViewBag.TotalUsers > 0 ? Math.Round((double)ViewBag.ActiveUsers * 100 / ViewBag.TotalUsers, 1) : 0)% Active Rate
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registration Trend -->
            <div class="col-lg-6">
                <div class="dashboard-card animate-fade-in">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                        <h5><i class="bi bi-graph-up"></i> Registration Trend</h5>
                        <div class="period-tabs">
                            <a asp-action="Users" asp-route-period="7days" class="period-tab @(ViewBag.CurrentPeriod == "7days" ? "active" : "")">7 Days</a>
                            <a asp-action="Users" asp-route-period="30days" class="period-tab @(ViewBag.CurrentPeriod == "30days" ? "active" : "")">30 Days</a>
                            <a asp-action="Users" asp-route-period="thismonth" class="period-tab @(ViewBag.CurrentPeriod == "thismonth" ? "active" : "")">This Month</a>
                            <a asp-action="Users" asp-route-period="thisyear" class="period-tab @(ViewBag.CurrentPeriod == "thisyear" ? "active" : "")">This Year</a>
                            <a asp-action="Users" asp-route-period="alltime" class="period-tab @(ViewBag.CurrentPeriod == "alltime" ? "active" : "")">All Time</a>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (ViewBag.RegistrationTrend != null && ((IEnumerable<dynamic>)ViewBag.RegistrationTrend).Any())
                        {
                            <div class="trend-bars">
                                @{
                                    var maxCount = ((IEnumerable<dynamic>)ViewBag.RegistrationTrend).Max(x => (int)x.Count);
                                    var format = ViewBag.DateFormat ?? "ddd";
                                }
                                @foreach (var item in ViewBag.RegistrationTrend)
                                {
                                    var height = maxCount > 0 ? (item.Count * 100 / maxCount) : 0;
                                    var dateLabel = ((DateTime)item.Date).ToString(format);
                                    <div class="trend-bar-item">
                                        <div class="trend-bar" style="height: @height%">
                                            <span class="trend-count">@item.Count</span>
                                        </div>
                                        <span class="trend-label">@dateLabel</span>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted text-center">No registration data for @ViewBag.PeriodLabel.</p>
                        }
                    </div>
                </div>
            </div>

            <!-- Top Users by Notes Count -->
            <div class="col-12">
                <div class="dashboard-card animate-fade-in">
                    <div class="card-header">
                        <h5><i class="bi bi-trophy"></i> Top Users by Notes Count</h5>
                    </div>
                    <div class="card-body">
                        @if (ViewBag.TopUsers != null && ((IEnumerable<dynamic>)ViewBag.TopUsers).Any())
                        {
                            <div class="top-users-list">
                                @{
                                    var rank = 1;
                                }
                                @foreach (var user in ViewBag.TopUsers)
                                {
                                    <div class="top-user-item">
                                        <div class="rank-badge rank-@rank">@rank</div>
                                        <div class="user-avatar">
                                            @if (!string.IsNullOrEmpty((string)user.ProfileImageUrl))
                                            {
                                                <img src="@user.ProfileImageUrl" alt="@user.FullName" />
                                            }
                                            else
                                            {
                                                <i class="bi bi-person"></i>
                                            }
                                        </div>
                                        <div class="user-info">
                                            <h6>@user.FullName</h6>
                                            <small>@user.Email</small>
                                        </div>
                                        <div class="notes-count">
                                            <span class="count-badge">@user.NotesCount</span>
                                            <small>notes</small>
                                        </div>
                                    </div>
                                    rank++;
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted text-center">No users with notes yet.</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
    